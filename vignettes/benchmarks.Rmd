---
title: "Benchmarking results and comparision with other packages"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Benchmarking results and comparision with other packages}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
devtools::load_all()
set.seed(2022)
```


## Microbenchmarks for Development

### A. Scaling with network size

```{r scaling}
results <- bench::press(
  Nsize = c(10, 100, 1000),
  {
    G <- sample_ppm2(Nsize, c=0.9, k=3, B=3)
    G <- simplify(G)
    G <- delete.vertices(G, degree(G) == 0)
    p <- sample(1:3, Nsize, replace = TRUE)
    bench::mark(
      min_iterations = 10,
      node_count = block_node_counts(p),
      edge_count = block_edge_counts(G, p),
      entropy = get_entropy(G, p),
      mcmc_sweep = mcmc_single_sweep(G, p, 3),
      check = FALSE
    )
  }
)
results
```



### B. Entropy Convergence Tests

#### 1. MCMC sweeps

```{r, eval = FALSE, echo = FALSE}
# Initialize graph and a random starting partition
Nsize = 60
G <- sample_ppm2(Nsize, c = 0.9, k = 10, B = 3)
p.start <- sample(1:3, Nsize, replace = TRUE)
G <- simplify(G)
E <- length(E(G))

# Number of mcmcm sweeps
Niter = 50

# Bookkeeping
p.new <- p.start
p.best <- p.start
dS.iter <- rep(0, Niter+1)
start.time <- Sys.time()

# Start mcmc sweeps
pb = txtProgressBar(min = 0, max = Niter, initial = 0, style = 3) 
for (i in 2:(Niter+1)) {
  sweep_results <- mcmc_single_sweep(G, p.new, 3, eps = 0.1)
  p.new <- sweep_results$new_partition
  dS.iter[i] <- dS.iter[i-1] + sweep_results$entropy_delta/E
  if(dS.iter[i] < min(dS.iter[1:(i-1)])) p.best <- p.new
  setTxtProgressBar(pb,i-1)
}
close(pb)

end.time <- Sys.time()
time.taken <- end.time - start.time
print(paste("Time per sweep =", time.taken/(Niter-1)))

# Visualize start/end partition and entropy delta.
plot(G, vertex.color = p.start, vertex.label = NA)
plot(dS.iter, type = "line")
plot(G, vertex.color = p.best, vertex.label = NA)
```


#### 2. Agglomerative Merge

```{r, eval = FALSE, echo = FALSE}
G <- sample_ppm2(300, 0.9, 10, 3)
G <- simplify(G)
p.start <- sample(1:30, length(G), replace=TRUE)
p.start <- check_partition(p.start)
p.new <- p.start
for (i in 1:(length(unique(p.start))-3)){
   cb <- collapse_step(G, p.new)
   print(paste(cb$g1, "->", cb$g2, "dS =", cb$dS))
   p.new <- cb$partition
   plot(G, vertex.color = p.new, vertex.label = NA)
}
```


### C. Entropy Convergence Test 2


